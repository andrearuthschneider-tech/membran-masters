<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioLab: Membran-Master EF</title>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #64748b;
            --accent: #10b981;
            --danger: #ef4444;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: var(--bg);
            background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--text);
            margin: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        #app {
            width: 100%;
            max-width: 900px;
            padding: 20px;
        }

        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .hidden { display: none !important; }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .timer-box {
            background: #fee2e2;
            color: var(--danger);
            padding: 8px 16px;
            border-radius: 99px;
            font-weight: bold;
            font-family: monospace;
        }

        /* Progress Bar */
        .progress-container {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }
        #progress-bar {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.4s ease;
        }

        /* Drag and Drop Styles */
        .drop-zone {
            min-height: 40px;
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 5px 15px;
            background: #f1f5f9;
            margin: 5px;
            cursor: pointer;
        }
        .drop-zone.active { border-color: var(--primary); background: #dbeafe; }
        .drop-zone.correct { border-color: var(--accent); background: #dcfce7; border-style: solid; }
        .drop-zone.wrong { border-color: var(--danger); background: #fee2e2; border-style: solid; }

        .draggable-pool {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
        }
        .chip {
            background: var(--primary);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: grab;
            user-select: none;
            font-size: 0.9rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chip.selected { ring: 3px solid #60a5fa; opacity: 0.7; }

        /* SVG Diagram Styling */
        .membrane-svg {
            width: 100%;
            height: auto;
            background: #fff;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        button.secondary { background: var(--secondary); }

        .feedback-box {
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid var(--primary);
            background: #f0f9ff;
        }

        textarea {
            width: 100%;
            height: 120px;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #cbd5e1;
            font-family: inherit;
            resize: vertical;
        }

        .protocol-view {
            font-family: monospace;
            background: #1e293b;
            color: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            white-space: pre-wrap;
            font-size: 0.85rem;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

<div id="app">
    <div id="screen-intro" class="card">
        <h1 style="color: var(--primary); margin-top: 0;">BioLab: Membran-Master</h1>
        <p>Willkommen zur interaktiven EF-Challenge zum Thema Transmembran-Transporte.</p>
        
        <div style="background: #eff6ff; padding: 15px; border-radius: 12px; margin: 20px 0; border: 1px solid #dbeafe;">
            <strong>Dein Pseudonym:</strong> 
            <span id="player-name" style="font-weight: bold; color: var(--primary);">...</span>
            <button onclick="setPseudonym()" class="secondary" style="padding: 4px 10px; font-size: 0.8rem; margin-left: 10px;">Anderes</button>
        </div>

        <p class="hint" style="font-size: 0.85rem; color: #64748b;">
            <strong>Datenschutzhinweis:</strong> Dieses Spiel nutzt ausschließlich lokale Pseudonymisierung. Es werden keine personenbezogenen Daten (Name, IP, Tracker) erhoben oder übertragen. Alle Ergebnisse bleiben in diesem Browserfenster.
        </p>
        <button onclick="initGame()" style="width: 100%;">Labor betreten & Start (20 Min.)</button>
    </div>

    <div id="screen-game" class="card hidden">
        <header>
            <div>
                <span id="lvl-display" style="font-weight: bold; font-size: 1.2rem;">Level 1</span>
            </div>
            <div class="timer-box" id="timer">20:00</div>
        </header>
        
        <div class="progress-container"><div id="progress-bar"></div></div>

        <div id="quest-container">
            </div>

        <div id="feedback-area" class="hidden"></div>

        <div style="margin-top: 25px; display: flex; gap: 10px; justify-content: flex-end;">
            <button id="btn-reset" class="secondary hidden" onclick="resetCurrentTask()">Reset</button>
            <button id="btn-action" onclick="checkAnswer()">Prüfen</button>
        </div>
    </div>

    <div id="screen-end" class="card hidden">
        <h1 style="color: var(--accent);">Abschluss-Protokoll</h1>
        <p>Hervorragend! Du hast die Labor-Challenge beendet.</p>
        <div id="protocol-text" class="protocol-view"></div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button onclick="copyProtocol()">Kopieren</button>
            <button onclick="downloadProtocol()">Download (.txt)</button>
            <button onclick="window.print()" class="secondary">Drucken</button>
            <button onclick="location.reload()" class="secondary">Neu starten</button>
        </div>
    </div>
</div>

<script>
    // --- Data & State ---
    const ADJ = ["Aktive", "Blaue", "Smarte", "Schnelle", "Polare", "Flüssige"];
    const ANM = ["Zelle", "Pumpe", "Membran", "Glucose", "Eule", "Biene"];
    
    let state = {
        name: "",
        timeLeft: 1200,
        currentLvl: 0,
        score: 0,
        gameEnded: false,
        results: [],
        unsureTopics: [],
        selectedChip: null,
        lvl5Text: "",
        itemsCorrect: 0,
        itemsTotal: 0
    };

    const LEVELS = [
        {
            title: "Level 1: Grundlagen (AFB I)",
            type: "choice",
            q: "Welcher Stoff benötigt KEIN Transportprotein, um durch die Membran zu gelangen?",
            options: [
                {t: "Sauerstoff (O2)", c: true, f: "Richtig! O2 ist klein und unpolar."},
                {t: "Glucose", c: false, f: "Falsch. Glucose ist groß und polar."},
                {t: "Natrium-Ionen (Na+)", c: false, f: "Falsch. Geladene Ionen kommen nicht durch die Lipide."}
            ],
            m: "Merksatz: Gase und sehr kleine unpolare Stoffe nutzen die einfache Diffusion."
        },
        {
            title: "Level 2: Begriffe (AFB I)",
            type: "choice",
            q: "Was unterscheidet einen Carrier von einem Kanalprotein?",
            options: [
                {t: "Carrier ändern ihre Form nach Bindung des Stoffes.", c: true, f: "Genau, das Schlüssel-Schloss-Prinzip."},
                {t: "Carrier sind immer offen wie eine Pore.", c: false, f: "Nein, das sind Kanäle."},
                {t: "Carrier verbrauchen niemals Energie.", c: false, f: "Es gibt auch aktive Carrier (Pumpen)!"}
            ],
            m: "Merksatz: Kanäle sind 'Tunnel', Carrier sind 'Fähren' mit Formänderung."
        },
        {
            title: "Level 3: Abbildung beschriften (AFB II)",
            type: "dragdrop",
            q: "Ordne die Bauteile der Membran korrekt zu. Klicke ein Label und dann das Zielfeld an.",
            labels: ["Lipid-Kopf", "Kanalprotein", "Carrier", "ATP", "Lipid-Schwanz"],
            targets: [
                { id: "t1", label: "Lipid-Kopf", hint: "Oberfläche der Schicht" },
                { id: "t2", label: "Lipid-Schwanz", hint: "Inneres der Schicht" },
                { id: "t3", label: "Kanalprotein", hint: "Pore für Ionen" },
                { id: "t4", label: "Carrier", hint: "Spezifischer Transporter" },
                { id: "t5", label: "ATP", hint: "Energiequelle unten" }
            ],
            m: "Merksatz: Die Membran ist ein Mosaik aus Lipiden und Proteinen."
        },
        {
            title: "Level 4: Szenarien (AFB II)",
            type: "choice",
            q: "Die Na+/K+-Pumpe befördert Ionen gegen ihr Konzentrationsgefälle. Was passiert genau?",
            options: [
                {t: "3 Na+ raus, 2 K+ rein unter ATP-Verbrauch.", c: true, f: "Korrekt! Das erhält das Membranpotential."},
                {t: "2 Na+ raus, 3 K+ rein, passiv.", c: false, f: "Falsch. Das Verhältnis und die Energie stimmen nicht."},
                {t: "3 Na+ rein, 2 K+ raus.", c: false, f: "Falsch. Na+ wird nach außen gepumpt."}
            ],
            m: "Merksatz: Pumpen arbeiten IMMER aktiv (mit ATP) gegen den Gradienten."
        },
        {
            title: "Level 5: Transfer (AFB III)",
            type: "free",
            q: "Stell dir vor, die ATP-Produktion einer Zelle stoppt plötzlich. Analysiere die Folgen für den Stofftransport und das Membranpotential.",
            placeholder: "Satzstarter: Wenn ATP fehlt, stoppt zuerst die... Infolgedessen gleichen sich die Gradienten an, weil... Das Membranpotential..."
        }
    ];

    // --- Core Logic ---

    function setPseudonym() {
        state.name = ADJ[Math.floor(Math.random()*ADJ.length)] + "-" + ANM[Math.floor(Math.random()*ANM.length)] + "-" + (Math.floor(Math.random()*899)+100);
        document.getElementById('player-name').innerText = state.name;
    }

    function initGame() {
        document.getElementById('screen-intro').classList.add('hidden');
        document.getElementById('screen-game').classList.remove('hidden');
        renderLevel();
        startTimer();
    }

    function startTimer() {
        const tDisplay = document.getElementById('timer');
        const interval = setInterval(() => {
            if (state.gameEnded) return clearInterval(interval);
            state.timeLeft--;
            let m = Math.floor(state.timeLeft / 60);
            let s = state.timeLeft % 60;
            tDisplay.innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            if (state.timeLeft <= 0) endGame();
        }, 1000);
    }

    function renderLevel() {
        const lvl = LEVELS[state.currentLvl];
        const container = document.getElementById('quest-container');
        const feedback = document.getElementById('feedback-area');
        const btnAction = document.getElementById('btn-action');
        const btnReset = document.getElementById('btn-reset');

        document.getElementById('lvl-display').innerText = lvl.title;
        document.getElementById('progress-bar').style.width = (state.currentLvl / LEVELS.length * 100) + "%";
        
        feedback.classList.add('hidden');
        btnReset.classList.add('hidden');
        btnAction.innerText = (lvl.type === 'free') ? "Abschließen" : "Prüfen";
        btnAction.disabled = (lvl.type === 'choice' || lvl.type === 'dragdrop');

        let html = `<p style="font-size: 1.1rem; margin-bottom: 20px;">${lvl.q}</p>`;

        if (lvl.type === "choice") {
            html += `<div style="display: flex; flex-direction: column; gap: 10px;">`;
            lvl.options.forEach((o, i) => {
                html += `<button class="secondary" style="text-align: left;" onclick="selectChoice(${i})">${o.t}</button>`;
            });
            html += `</div>`;
        } 
        else if (lvl.type === "dragdrop") {
            btnReset.classList.remove('hidden');
            html += `<div class="draggable-pool" id="pool">`;
            lvl.labels.sort(() => Math.random() - 0.5).forEach(l => {
                html += `<div class="chip" draggable="true" ondragstart="drag(event)" onclick="clickChip(this)">${l}</div>`;
            });
            html += `</div>`;
            
            // SVG Membrane Diagram
            html += `
            <svg viewBox="0 0 500 200" class="membrane-svg">
                ${Array.from({length: 12}).map((_, i) => {
                    const x = i * 42;
                    if (i === 4 || i === 8) return ''; // Space for proteins
                    return `
                    <circle cx="${x+20}" cy="50" r="8" fill="#60a5fa" />
                    <line x1="${x+17}" y1="58" x2="${x+17}" y2="75" stroke="#94a3b8" />
                    <line x1="${x+23}" y1="58" x2="${x+23}" y2="75" stroke="#94a3b8" />
                    <circle cx="${x+20}" cy="100" r="8" fill="#60a5fa" />
                    <line x1="${x+17}" y1="92" x2="${x+17}" y2="75" stroke="#94a3b8" />
                    <line x1="${x+23}" y1="92" x2="${x+23}" y2="75" stroke="#94a3b8" />`;
                }).join('')}
                <rect x="160" y="30" width="40" height="90" rx="5" fill="#10b981" opacity="0.8" />
                <rect x="175" y="30" width="10" height="90" fill="#fff" />
                <path d="M330 30 L370 30 L350 75 Z" fill="#f59e0b" />
                <path d="M330 120 L370 120 L350 75 Z" fill="#f59e0b" />
            </svg>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">`;
            lvl.targets.forEach(t => {
                html += `<div><small>${t.hint}:</small><br><div class="drop-zone" id="${t.id}" ondrop="drop(event)" ondragover="allowDrop(event)" onclick="clickTarget(this)">Drop hier</div></div>`;
            });
            html += `</div>`;
        }
        else if (lvl.type === "free") {
            html += `<textarea id="free-text" placeholder="${lvl.placeholder}" oninput="state.lvl5Text = this.value; checkFreeLength()"></textarea>`;
        }

        container.innerHTML = html;
    }

    // --- Interaction Logic ---

    function selectChoice(idx) {
        state.tempChoice = idx;
        const btns = document.querySelectorAll('#quest-container button');
        btns.forEach((b, i) => {
            b.style.border = (i === idx) ? '2px solid var(--primary)' : 'none';
        });
        document.getElementById('btn-action').disabled = false;
    }

    // Drag & Drop Hybrid Logic
    function allowDrop(ev) { ev.preventDefault(); }
    function drag(ev) { ev.dataTransfer.setData("text", ev.target.innerText); }
    function drop(ev) {
        ev.preventDefault();
        const data = ev.dataTransfer.getData("text");
        placeItem(ev.target, data);
    }
    function clickChip(el) {
        if (state.selectedChip) state.selectedChip.classList.remove('selected');
        state.selectedChip = el;
        el.classList.add('selected');
    }
    function clickTarget(el) {
        if (state.selectedChip) {
            placeItem(el, state.selectedChip.innerText);
            state.selectedChip.classList.remove('selected');
            state.selectedChip = null;
        }
    }
    function placeItem(target, text) {
        if (target.classList.contains('drop-zone')) {
            target.innerText = text;
            target.style.background = "#fff";
            target.style.borderStyle = "solid";
            checkAllZonesFilled();
        }
    }
    function checkAllZonesFilled() {
        const zones = document.querySelectorAll('.drop-zone');
        const allFilled = Array.from(zones).every(z => z.innerText !== "Drop hier");
        document.getElementById('btn-action').disabled = !allFilled;
    }
    function resetCurrentTask() { renderLevel(); }

    function checkFreeLength() {
        document.getElementById('btn-action').disabled = (state.lvl5Text.length < 30);
    }

    // --- Validation & Feedback ---

    function checkAnswer() {
        const lvl = LEVELS[state.currentLvl];
        const feedback = document.getElementById('feedback-area');
        const actionBtn = document.getElementById('btn-action');
        
        if (actionBtn.innerText === "Weiter" || actionBtn.innerText === "Abschluss") {
            state.currentLvl++;
            if (state.currentLvl < LEVELS.length) renderLevel();
            else endGame();
            return;
        }

        feedback.classList.remove('hidden');
        let isCorrect = true;
        let summary = "";

        if (lvl.type === "choice") {
            const opt = lvl.options[state.tempChoice];
            isCorrect = opt.c;
            summary = `<strong style="color:${isCorrect ? 'var(--accent)' : 'var(--danger)'}">${isCorrect ? 'Richtig!' : 'Leider nicht ganz.'}</strong><br>${opt.f}`;
            if (isCorrect) state.score += 20;
            else state.unsureTopics.push(lvl.title);
        } 
        else if (lvl.type === "dragdrop") {
            let correctCount = 0;
            lvl.targets.forEach(t => {
                const zone = document.getElementById(t.id);
                if (zone.innerText === t.label) {
                    zone.classList.add('correct');
                    correctCount++;
                } else {
                    zone.classList.add('wrong');
                    isCorrect = false;
                }
            });
            state.itemsCorrect += correctCount;
            state.itemsTotal += lvl.targets.length;
            summary = `<strong>Ergebnis: ${correctCount}/${lvl.targets.length} korrekt beschriftet.</strong>`;
            state.score += (correctCount * 5);
        }

        feedback.innerHTML = `<div class="feedback-box">${summary}<br><small><em>${lvl.m || ''}</em></small></div>`;
        actionBtn.innerText = "Weiter";
        state.results.push(`${lvl.title}: ${isCorrect ? 'Bestanden' : 'Nacharbeiten'}`);
    }

    // --- Finalization ---

    function endGame() {
        state.gameEnded = true;
        document.getElementById('progress-bar').style.width = "100%";
        document.getElementById('screen-game').classList.add('hidden');
        document.getElementById('screen-end').classList.remove('hidden');
        document.getElementById('protocol-text').innerText = generateProtocol();
    }

    function generateProtocol() {
        const timeSpent = 1200 - state.timeLeft;
        return `BIOLAB LERNPROTOKOLL\n====================\n` +
               `Datum: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}\n` +
               `Pseudonym: ${state.name}\n` +
               `Dauer: ${Math.floor(timeSpent/60)}m ${timeSpent%60}s\n` +
               `Punkte: ${state.score}\n\n` +
               `LEVEL-DETAILS:\n${state.results.join('\n')}\n` +
               `Beschriftung: ${state.itemsCorrect}/${state.itemsTotal} korrekt.\n\n` +
               `UNSICHERE THEMEN:\n${state.unsureTopics.length ? state.unsureTopics.join(', ') : 'Keine'}\n\n` +
               `TRANSFER (LEVEL 5):\n${state.lvl5Text || 'Kein Text eingegeben.'}\n\n` +
               `--------------------\nDieses Dokument dient als Lernnachweis.`;
    }

    function copyProtocol() {
        const text = generateProtocol();
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => alert("Kopiert!"));
        } else {
            alert("Hinweis: Automatisches Kopieren im Browser gesperrt. Bitte markiere den Text im schwarzen Feld und drücke Strg+C.");
        }
    }

    function downloadProtocol() {
        const blob = new Blob([generateProtocol()], {type: 'text/plain'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `BioLab_Protokoll_${state.name}.txt`;
        a.click();
        setTimeout(() => URL.revokeObjectURL(url), 100);
    }

    setPseudonym();
</script>
</body>
</html>

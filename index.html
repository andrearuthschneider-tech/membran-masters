<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioLab: Transmembran-Prozesse</title>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --bg: #f4f7f6; --text: #333; --white: #ffffff; }
        body { font-family: sans-serif; background-color: var(--bg); color: var(--text); line-height: 1.6; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        #app { width: 95%; max-width: 850px; background: var(--white); padding: 2rem; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--bg); padding-bottom: 1rem; margin-bottom: 1rem; }
        .timer { font-weight: bold; color: #e74c3c; font-size: 1.2rem; font-family: monospace; }
        button { background: var(--primary); color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 5px; cursor: pointer; font-size: 1rem; }
        button:hover { opacity: 0.9; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .option-btn { display: block; width: 100%; text-align: left; margin: 0.5rem 0; background: #ecf0f1; color: var(--text); }
        .selected { background: var(--accent) !important; color: white; }
        .privacy-note { font-size: 0.75rem; color: #7f8c8d; border-top: 1px solid #eee; margin-top: 1.5rem; padding-top: 0.5rem; }
        .progress-bar { height: 10px; background: #eee; border-radius: 5px; margin: 1rem 0; overflow: hidden; }
        #progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }
        textarea { width: 100%; height: 120px; box-sizing: border-box; padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-family: inherit; }
        .protocol-box { background: #f9f9f9; padding: 1rem; border: 1px solid #ddd; white-space: pre-wrap; font-family: monospace; font-size: 0.85rem; max-height: 300px; overflow-y: auto; margin-bottom: 1rem; }
    </style>
</head>
<body>

<div id="app">
    <div id="screen-intro">
        <h1>BioLab: Transmembranprozesse</h1>
        <p>EF Biologie Challenge: 5 Level, 20 Minuten Zeit.</p>
        <div style="background: #e8f4fd; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
            <strong>Dein Pseudonym:</strong> <span id="pseudonym-display">...</span>
            <button onclick="generatePseudonym()" style="padding: 2px 10px; font-size: 0.8rem; margin-left: 10px;">Neu würfeln</button>
        </div>
        <button onclick="startGame()" style="width: 100%; font-size: 1.2rem;">Starten</button>
        <div class="privacy-note">
            <strong>Datenschutz:</strong> Dieses Spiel arbeitet nach dem Prinzip der Datenminimierung. Es werden keine Klarnamen oder IP-Adressen erfasst. Das Pseudonym dient der Zuordnung des lokalen Protokolls. Keine Netzwerkanfragen.
        </div>
    </div>

    <div id="screen-game" class="hidden">
        <header>
            <div id="level-title" style="font-weight: bold;">Level 1</div>
            <div class="timer" id="timer-display">20:00</div>
        </header>
        <div class="progress-bar"><div id="progress-fill"></div></div>
        <div id="level-content"></div>
        <div style="margin-top: 1.5rem; display: flex; justify-content: flex-end;">
            <button id="next-btn" onclick="nextStep()">Weiter</button>
        </div>
    </div>

    <div id="screen-result" class="hidden">
        <h1>Abschluss-Protokoll</h1>
        <div id="protocol-output" class="protocol-box"></div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button onclick="copyProtocol()">Kopieren</button>
            <button onclick="downloadProtocol()">Download (.txt)</button>
            <button onclick="window.print()">Drucken</button>
            <button onclick="location.reload()">Neustart</button>
        </div>
    </div>
</div>

<script>
    const ADJECTIVES = ["Aktive", "Osmotische", "Lipophile", "Spezifische", "Schnelle", "Polare"];
    const ANIMALS = ["Zelle", "Membran", "Pumpe", "Glucose", "Eule", "Biene"];
    
    let state = {
        pseudonym: "",
        timeLeft: 1200,
        gameEnded: false,
        currentStep: 0,
        score: 0,
        results: [],
        unsureTopics: [],
        lastSelection: null,
        lastTopic: "",
        level5Text: ""
    };

    // Erweitertes Fragen-Set
    const STEPS = [
        // Level 1: AFB I
        { level: 1, title: "Lvl 1: Grundlagen", type: "choice", q: "Was ist das Hauptmerkmal der einfachen Diffusion?", topic: "Einfache Diffusion", options: [
            {t: "Direkter Durchtritt durch die Lipiddoppelschicht", c: true},
            {t: "Transport via ATP-Verbrauch", c: false},
            {t: "Nutzung von Tunnelproteinen", c: false}
        ]},
        { level: 1, title: "Lvl 1: Grundlagen", type: "choice", q: "Welche Gase diffundieren einfach durch die Membran?", topic: "Einfache Diffusion", options: [
            {t: "O2 und CO2", c: true},
            {t: "Nur Stickstoff", c: false},
            {t: "Große Proteingase", c: false}
        ]},
        // Level 2: AFB I
        { level: 2, title: "Lvl 2: Proteine", type: "choice", q: "Ein Kanalprotein ist meist...", topic: "Kanalproteine", options: [
            {t: "Spezifisch für bestimmte Ionen", c: true},
            {t: "Ein aktiver Transporter", c: false},
            {t: "Nur für Fette durchlässig", c: false}
        ]},
        { level: 2, title: "Lvl 2: Proteine", type: "choice", q: "Was ist typisch für einen Carrier?", topic: "Carrier", options: [
            {t: "Konformationsänderung (Schlüssel-Schloss)", c: true},
            {t: "Immer offen wie eine Pore", c: false},
            {t: "Transportiert nur Gase", c: false}
        ]},
        // Level 3: AFB II
        { level: 3, title: "Lvl 3: Szenarien", type: "choice", q: "Glucosekonzentration: Außen hoch, innen niedrig. Welcher Weg?", topic: "Erleichterte Diffusion", options: [
            {t: "Erleichterte Diffusion (Carrier)", c: true},
            {t: "Einfache Diffusion", c: false},
            {t: "Primär aktiver Transport", c: false}
        ]},
        { level: 3, title: "Lvl 3: Szenarien", type: "choice", q: "Ein Ion soll gegen sein Gefälle nach außen. Was ist nötig?", topic: "Aktiver Transport", options: [
            {t: "Energie (ATP) + Transportprotein", c: true},
            {t: "Nur ein offener Kanal", c: false},
            {t: "Einfache Diffusion", c: false}
        ]},
        // Level 4: AFB II
        { level: 4, title: "Lvl 4: Na+/K+-Pumpe", type: "choice", q: "Wie viele Natrium-Ionen werden pro ATP-Zyklus exportiert?", topic: "Na/K-Pumpe", options: [
            {t: "3 Na+ Ionen", c: true},
            {t: "2 Na+ Ionen", c: false},
            {t: "Keine, nur Kalium", c: false}
        ]},
        { level: 4, title: "Lvl 4: Na+/K+-Pumpe", type: "choice", q: "In welche Richtung wird Kalium (K+) gepumpt?", topic: "Na/K-Pumpe", options: [
            {t: "Nach innen, gegen das Gefälle", c: true},
            {t: "Nach außen, mit dem Gefälle", c: false},
            {t: "Garnicht, es diffundiert nur", c: false}
        ]},
        // Level 5: AFB III
        { level: 5, title: "Lvl 5: Transfer", type: "free", q: "Analysiere: Warum ist die Na+/K+-Pumpe für das Ruhepotenzial einer Nervenzelle essenziell, wenn Ionenkanäle ständig 'lecken'?" }
    ];

    function generatePseudonym() {
        state.pseudonym = `${ADJECTIVES[Math.floor(Math.random()*ADJECTIVES.length)]}-${ANIMALS[Math.floor(Math.random()*ANIMALS.length)]}-${Math.floor(Math.random()*900+100)}`;
        document.getElementById('pseudonym-display').innerText = state.pseudonym;
    }

    function startGame() {
        document.getElementById('screen-intro').classList.add('hidden');
        document.getElementById('screen-game').classList.remove('hidden');
        renderStep();
        const timer = setInterval(() => {
            if(state.gameEnded) return clearInterval(timer);
            state.timeLeft--;
            const m = Math.floor(state.timeLeft / 60).toString().padStart(2, '0');
            const s = (state.timeLeft % 60).toString().padStart(2, '0');
            document.getElementById('timer-display').innerText = `${m}:${s}`;
            if(state.timeLeft <= 0) endGame();
        }, 1000);
    }

    function renderStep() {
        const step = STEPS[state.currentStep];
        state.lastSelection = null;
        document.getElementById('level-title').innerText = step.title;
        document.getElementById('next-btn').disabled = (step.type === 'choice');
        document.getElementById('progress-fill').style.width = `${(state.currentStep / STEPS.length) * 100}%`;

        let html = `<p style="font-weight:bold;">${step.q}</p>`;
        if(step.type === 'choice') {
            step.options.forEach((o, i) => {
                html += `<button class="option-btn" onclick="selectOpt(${i}, ${o.c}, '${step.topic}')">${o.t}</button>`;
            });
        } else {
            html += `<textarea id="l5-input" oninput="state.level5Text = this.value" placeholder="Schreibe 4-6 Sätze..."></textarea>`;
        }
        document.getElementById('level-content').innerHTML = html;
    }

    window.selectOpt = (idx, isCorrect, topic) => {
        state.lastSelection = isCorrect;
        state.lastTopic = topic;
        document.querySelectorAll('.option-btn').forEach((b, i) => b.className = i === idx ? 'option-btn selected' : 'option-btn');
        document.getElementById('next-btn').disabled = false;
    };

    function nextStep() {
        if(state.currentStep < STEPS.length - 1) {
            if(STEPS[state.currentStep].type === 'choice') {
                if(state.lastSelection) state.score += 10;
                else state.unsureTopics.push(state.lastTopic);
                state.results.push(`Schritt ${state.currentStep+1}: ${state.lastSelection ? 'Richtig' : 'Falsch'}`);
            }
            state.currentStep++;
            renderStep();
        } else {
            document.getElementById('progress-fill').style.width = '100%';
            endGame();
        }
    }

    function endGame() {
        if(state.gameEnded) return;
        state.gameEnded = true;
        document.getElementById('screen-game').classList.add('hidden');
        document.getElementById('screen-result').classList.remove('hidden');
        document.getElementById('protocol-output').innerText = generateProtocol();
    }

    function generateProtocol() {
        return `PROTOKOLL: TRANSMEMBRANPROZESSE
-------------------------------------------
Pseudonym: ${state.pseudonym}
Punkte (AFB I/II): ${state.score}
Zeit übrig: ${document.getElementById('timer-display').innerText}

LEVEL-ERGEBNISSE:
${state.results.join('\n')}

UNSICHERE THEMEN:
${[...new Set(state.unsureTopics)].join(', ') || 'Keine'}

FREITEXT (AFB III):
${state.level5Text || 'Keine Eingabe.'}
-------------------------------------------`;
    }

    window.copyProtocol = () => {
        const txt = generateProtocol();
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(txt).then(() => alert("Kopiert!"));
        } else {
            alert("Clipboard-Zugriff verweigert. Bitte markiere den Text im Feld manuell und drücke Strg+C.");
        }
    };

    window.downloadProtocol = () => {
        const blob = new Blob([generateProtocol()], {type: 'text/plain'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `BioLab_${state.pseudonym}.txt`;
        a.click();
        setTimeout(() => URL.revokeObjectURL(url), 100);
    };

    generatePseudonym();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioLab: Transmembran-Prozesse</title>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --wrong: #e74c3c; --bg: #f4f7f6; --text: #333; --white: #ffffff; }
        body { font-family: sans-serif; background-color: var(--bg); color: var(--text); line-height: 1.6; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        #app { width: 95%; max-width: 800px; background: var(--white); padding: 2rem; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--bg); padding-bottom: 1rem; margin-bottom: 1rem; }
        .timer { font-weight: bold; color: var(--wrong); font-size: 1.2rem; font-family: monospace; }
        button { background: var(--primary); color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 5px; cursor: pointer; font-size: 1rem; }
        button:hover { opacity: 0.9; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .option-btn { display: block; width: 100%; text-align: left; margin: 0.5rem 0; background: #ecf0f1; color: var(--text); padding: 10px; border-radius: 5px; border: 1px solid #ddd; }
        .selected-correct { background: var(--accent) !important; color: white; border-color: #1e8449; }
        .selected-wrong { background: var(--wrong) !important; color: white; border-color: #c0392b; }
        .feedback-area { margin-top: 1rem; padding: 1rem; border-radius: 8px; border-left: 5px solid var(--primary); background: #f9f9f9; }
        .progress-bar { height: 10px; background: #eee; border-radius: 5px; margin: 1rem 0; overflow: hidden; }
        #progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }
        textarea { width: 100%; height: 120px; box-sizing: border-box; padding: 10px; margin-top: 10px; border: 1px solid #ccc; font-family: inherit; }
        .protocol-box { background: #f1f1f1; padding: 1rem; border: 1px solid #ccc; white-space: pre-wrap; font-family: monospace; font-size: 0.85rem; max-height: 300px; overflow-y: auto; margin-bottom: 1rem; }
        .hint { font-size: 0.85rem; color: #666; font-style: italic; }
    </style>
</head>
<body>

<div id="app">
    <div id="screen-intro">
        <h1>BioLab: Transmembran-Check</h1>
        <p>Meistere 5 Level zu Zellmembran-Transporten. Du hast 20 Minuten Zeit.</p>
        <div style="background: #e8f4fd; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
            <strong>Dein Pseudonym:</strong> <span id="pseudonym-display">...</span>
            <button onclick="generatePseudonym()" style="padding: 2px 10px; font-size: 0.8rem; margin-left: 10px;">Neu würfeln</button>
        </div>
        <button onclick="startGame()" style="width: 100%; font-size: 1.2rem;">Starten</button>
        <p class="hint">Datenschutz: Keine Datenerfassung, keine Cookies, alles bleibt offline in diesem Browser.</p>
    </div>

    <div id="screen-game" class="hidden">
        <header>
            <div id="level-info" style="font-weight: bold;">Level 1</div>
            <div class="timer" id="timer-display">20:00</div>
        </header>
        <div class="progress-bar"><div id="progress-fill"></div></div>
        <div id="game-area">
            <p id="question-text" style="font-weight: bold; font-size: 1.1rem;"></p>
            <div id="options-container"></div>
            <div id="feedback-container" class="feedback-area hidden"></div>
        </div>
        <div style="margin-top: 1.5rem; display: flex; justify-content: flex-end;">
            <button id="next-btn" onclick="handleNext()" disabled>Antwort prüfen</button>
        </div>
    </div>

    <div id="screen-result" class="hidden">
        <h1>Dein Ergebnis</h1>
        <div id="protocol-output" class="protocol-box"></div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button onclick="copyProtocol()">In Zwischenablage kopieren</button>
            <button onclick="downloadProtocol()">Als .txt herunterladen</button>
            <button onclick="window.print()">Drucken</button>
            <button onclick="location.reload()">Neustart</button>
        </div>
    </div>
</div>

<script>
    const ADJ = ["Aktive", "Blaue", "Schnelle", "Smarte", "Osmotische", "Kleine"];
    const ANM = ["Zelle", "Pumpe", "Membran", "Ionenwolke", "Biene", "Eule"];
    
    let state = {
        pseudonym: "", timeLeft: 1200, gameEnded: false, currentStep: 0,
        score: 0, results: [], unsureTopics: [], misconceptions: [],
        currentAnswer: null, level5Text: "", stage: 'answering' // answering | feedback
    };

    const QUESTIONS = [
        // Level 1: AFB I - Basics
        { q: "Wie gelangen sehr kleine Teilchen wie Sauerstoff (O2) meist in die Zelle?", 
          topic: "Einfache Diffusion", level: 1, type: "mc",
          options: [
              {t: "Einfache Diffusion: Direkt durch die Lipidschicht.", c: true, f: "O2 ist lipophil genug und klein, es braucht keinen Helfer."},
              {t: "Aktiver Transport: Die Zelle pumpt jedes Molekül einzeln.", c: false, f: "Falsch. Das würde viel zu viel Energie kosten."},
              {t: "Carrier: Ein Protein muss jedes O2-Molekül binden.", c: false, f: "Nicht nötig. O2 flutscht einfach durch die Membran."}
          ], m: "Merksatz: Kleine, ungeladene Teilchen diffundieren passiv direkt durch die Lipide." },
        
        { q: "Was bedeutet 'passiver Transport'?", 
          topic: "Transport-Energie", level: 1, type: "mc",
          options: [
              {t: "Transport ohne Energieverbrauch (ATP).", c: true, f: "Richtig. Die Teilchen nutzen ihre eigene Bewegungsenergie."},
              {t: "Transport, der nur mit viel ATP funktioniert.", c: false, f: "Falsch. Das wäre aktiver Transport."},
              {t: "Transport, der gegen das Gefälle geht.", c: false, f: "Falsch. Passiv geht immer nur 'bergab' (mit dem Gefälle)."}
          ], m: "Merksatz: Passiv = Ohne ATP, mit dem Konzentrationsgefälle." },

        // Level 2: AFB I - Proteine
        { q: "Welches Protein bildet eine wassergefüllte Pore für Ionen?", 
          topic: "Kanalproteine", level: 2, type: "mc",
          options: [
              {t: "Kanalprotein", c: true, f: "Richtig. Wie ein Tunnel, der sich öffnen und schließen kann."},
              {t: "Carrierprotein", c: false, f: "Falsch. Ein Carrier ändert seine Form nach einer Bindung."},
              {t: "Lipid-Pumpe", c: false, f: "Falsch. Eine Pumpe braucht Energie."}
          ], m: "Merksatz: Kanäle sind schnelle 'Tunnel' für Ionen oder Wasser." },

        // Level 3: AFB II - Anwendung
        { q: "Szenario: Außen ist viel Glucose, innen wenig. Die Zelle nutzt einen Carrier. Welcher Prozess liegt vor?", 
          topic: "Erleichterte Diffusion", level: 3, type: "mc",
          options: [
              {t: "Erleichterte Diffusion", c: true, f: "Richtig. Ein Protein hilft (erleichtert), aber es kostet keine Energie."},
              {t: "Primär aktiver Transport", c: false, f: "Falsch. Da das Gefälle genutzt wird, ist kein ATP nötig."},
              {t: "Einfache Diffusion", c: false, f: "Falsch. Glucose ist zu groß und polar für die Lipidschicht."}
          ], m: "Merksatz: Große/polare Stoffe brauchen Proteine als 'Türsteher' (erleichterte Diffusion)." },

        // Level 4: AFB II - Die Pumpe
        { q: "Die Na+/K+-Pumpe befördert Natrium gegen ein starkes Gefälle nach außen. Was ist dafür zwingend nötig?", 
          topic: "Aktiver Transport", level: 4, type: "mc",
          options: [
              {t: "Energie in Form von ATP.", c: true, f: "Richtig. Gegen das Gefälle muss 'gepumpt' werden."},
              {t: "Nur ein offener Ionenkanal.", c: false, f: "Falsch. Durch einen Kanal würde Natrium nach innen strömen."},
              {t: "Sonnenlicht.", c: false, f: "Falsch. Die Zelle nutzt chemische Energie (ATP)."}
          ], m: "Merksatz: Aktiver Transport = Verbraucht ATP, pumpt gegen das Gefälle." },

        // Level 5: AFB III - Transfer
        { q: "Level 5: Transfer-Aufgabe. Erkläre kurz: Warum würde das Ruhepotenzial einer Nervenzelle zusammenbrechen, wenn die Zelle kein ATP mehr produzieren kann?", 
          level: 5, type: "free" }
    ];

    function generatePseudonym() {
        state.pseudonym = `${ADJ[Math.floor(Math.random()*ADJ.length)]}-${ANM[Math.floor(Math.random()*ANM.length)]}-${Math.floor(Math.random()*900+100)}`;
        document.getElementById('pseudonym-display').innerText = state.pseudonym;
    }

    function startGame() {
        document.getElementById('screen-intro').classList.add('hidden');
        document.getElementById('screen-game').classList.remove('hidden');
        renderStep();
        const timer = setInterval(() => {
            if(state.gameEnded) return clearInterval(timer);
            state.timeLeft--;
            const m = Math.floor(state.timeLeft / 60).toString().padStart(2, '0');
            const s = (state.timeLeft % 60).toString().padStart(2, '0');
            document.getElementById('timer-display').innerText = `${m}:${s}`;
            if(state.timeLeft <= 0) endGame();
        }, 1000);
    }

    function renderStep() {
        const q = QUESTIONS[state.currentStep];
        state.stage = 'answering';
        state.currentAnswer = null;
        
        document.getElementById('level-info').innerText = `Level ${q.level}`;
        document.getElementById('progress-fill').style.width = `${(state.currentStep / QUESTIONS.length) * 100}%`;
        document.getElementById('question-text').innerText = q.q;
        document.getElementById('next-btn').disabled = true;
        document.getElementById('next-btn').innerText = "Antwort prüfen";
        document.getElementById('feedback-container').classList.add('hidden');
        
        const container = document.getElementById('options-container');
        container.innerHTML = "";

        if(q.type === 'mc') {
            
            q.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = "option-btn";
                btn.innerText = opt.t;
                btn.onclick = () => selectOption(idx);
                container.appendChild(btn);
            });
        } else {
            container.innerHTML = `
                <p class="hint">Nutze diese Satzanfänge: "Ohne ATP kann die Na+/K+-Pumpe nicht...", "Dadurch fließen die Ionen durch Kanäle..."</p>
                <textarea id="l5-input" placeholder="Schreibe hier deine Begründung (mind. 2 Sätze)..."></textarea>
            `;
            document.getElementById('next-btn').disabled = false;
            document.getElementById('next-btn').innerText = "Abschließen";
        }
    }

    function selectOption(idx) {
        if(state.stage !== 'answering') return;
        state.currentAnswer = idx;
        const btns = document.querySelectorAll('.option-btn');
        btns.forEach((b, i) => b.style.borderColor = (i === idx) ? 'var(--primary)' : '#ddd');
        document.getElementById('next-btn').disabled = false;
    }

    function handleNext() {
        const q = QUESTIONS[state.currentStep];
        
        if(q.type === 'free') {
            state.level5Text = document.getElementById('l5-input').value;
            endGame();
            return;
        }

        if(state.stage === 'answering') {
            showFeedback();
        } else {
            state.currentStep++;
            renderStep();
        }
    }

    function showFeedback() {
        state.stage = 'feedback';
        const q = QUESTIONS[state.currentStep];
        const selected = q.options[state.currentAnswer];
        const feedbackBox = document.getElementById('feedback-container');
        const btns = document.querySelectorAll('.option-btn');
        
        btns.forEach((b, i) => {
            b.disabled = true;
            if(q.options[i].c) b.classList.add('selected-correct');
            if(i === state.currentAnswer && !q.options[i].c) b.classList.add('selected-wrong');
        });

        feedbackBox.classList.remove('hidden');
        if(selected.c) {
            state.score += 10;
            feedbackBox.innerHTML = `<b style="color:var(--accent)">Richtig!</b><br>${selected.f}<br><i>${q.m}</i>`;
            state.results.push(`Level ${q.level}: Korrekt`);
        } else {
            state.unsureTopics.push(q.topic);
            if(selected.t.includes("ATP") && q.topic === "Transport-Energie") state.misconceptions.push("ATP/Passiv-Verwechslung");
            
            const correctText = q.options.find(o => o.c).t;
            feedbackBox.innerHTML = `<b style="color:var(--wrong)">Nicht ganz korrekt.</b><br>${selected.f}<br><b>Richtig wäre:</b> ${correctText}<br><i>${q.m}</i>`;
            state.results.push(`Level ${q.level}: Falsch (${q.topic})`);
        }

        document.getElementById('next-btn').innerText = "Weiter zum nächsten Schritt";
    }

    function endGame() {
        if(state.gameEnded) return;
        state.gameEnded = true;
        document.getElementById('progress-fill').style.width = '100%';
        document.getElementById('screen-game').classList.add('hidden');
        document.getElementById('screen-result').classList.remove('hidden');
        document.getElementById('protocol-output').innerText = generateProtocol();
    }

    function generateProtocol() {
        const timeUsed = 1200 - state.timeLeft;
        const m = Math.floor(timeUsed/60).toString().padStart(2,'0');
        const s = (timeUsed%60).toString().padStart(2,'0');
        
        return `LERNPROTOKOLL: BIOLAB TRANSMEMBRAN
-------------------------------------------
Pseudonym: ${state.pseudonym}
Datum: ${new Date().toLocaleString()}
Zeitaufwand: ${m}:${s}
Punkte: ${state.score} / 50 (AFB I/II)

ERGEBNISSE:
${state.results.join('\n')}

UNSICHERE THEMEN:
${[...new Set(state.unsureTopics)].join(', ') || 'Keine'}

FEHLVORSTELLUNGEN ERKANNT:
${[...new Set(state.misconceptions)].join(', ') || 'Keine'}

LEVEL 5 (AFB III) TEXT:
${state.level5Text || 'Keine Eingabe.'}
-------------------------------------------`;
    }

    window.copyProtocol = () => {
        const txt = generateProtocol();
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(txt).then(() => alert("Kopiert!"));
        } else {
            alert("Sicherheits-Blockierung: Bitte markiere den Text manuell und kopiere ihn (Strg+C).");
        }
    };

    window.downloadProtocol = () => {
        const blob = new Blob([generateProtocol()], {type: 'text/plain'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `BioLab_${state.pseudonym}.txt`;
        a.click();
        setTimeout(() => URL.revokeObjectURL(url), 100);
    };

    generatePseudonym();
</script>
</body>
</html>
